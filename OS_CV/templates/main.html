<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <title>OS-cv</title>
    <style>
      body {
        margin: 0;
        background: linear-gradient(135deg, #d7e1ec, #f3f3f3);
        font-family: sans-serif;
        overflow: hidden;
      }

      .inverted {
        clip-path: url(#clip);
        width: 100%;
        height: 100px;
        background-color: #b1b1b1;
        aspect-ratio: 4 / 1;
      }

      .row > * {
        flex-shrink: 0;
        width: 100%;
        max-width: 80%;
        padding-right: calc(var(--bs-gutter-x) * 0.5);
        padding-left: calc(var(--bs-gutter-x) * 0.5);
        margin-top: var(--bs-gutter-y);
      }

      .skill-box {
        clip-path: url(#clip-skill);
        width: 80px;
        height: 75px;
        background-color: var(--color);
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 15px;
        transition: transform 0.3s ease, filter 0.3s ease;
      }

      .skill-box img {
        width: 60%;
      }

      .skill-box:hover {
        transform: scale(1.1);
        filter: brightness(1.2);
        cursor: pointer;
      }

      .fixed-top-right {
        background: rgba(
          60,
          60,
          60,
          0.8
        ); /* خاکستری تیره شفاف‌تر برای حس مدرن */
        color: white; /* برای دید بهتر متن روی زمینه */
        width: fit-content; /* اندازه فقط به اندازه محتوا */
        padding: 8px 15px; /* فاصله داخلی مناسب */
        display: flex;
        align-items: center;
        gap: 20px; /* فاصله بین ساعت، تاریخ، باتری */
        border-radius: 12px;
        position: fixed;
        right: 15px;
        top: 10px;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(6px); /* افکت شیشه‌ای جذاب */
        z-index: 1000;
      }

      #battery-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
      }

      #battery-outline {
        width: 40px;
        height: 20px;
        border: 2px solid #ddd;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }

      #battery-cap {
        width: 4px;
        height: 10px;
        background: #ddd;
        border-radius: 2px;
        margin-left: -6px;
      }

      #battery-level {
        height: 100%;
        width: 50%;
        background: #4caf50;
        transition: width 0.5s ease, background 0.5s ease;
      }

      #battery-percentage {
        font-size: 0.9rem;
      }

      .app-window {
        position: absolute;
        top: 100px;
        left: 100px;
        width: 400px;
        background: #f3f3f3;
        border: 2px solid #444;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 100;
        display: none;
      }

      .app-header {
        background: #555;
        color: white;
        padding: 8px;
        border-radius: 6px 6px 0 0;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .app-content {
        padding: 10px;
        color: #222;
      }

      .app-window {
        resize: both;
        overflow: auto;
      }

      #desktop-icons {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .app-icon {
        text-align: center;
        width: 80px;
        cursor: pointer;
      }

      .app-icon img {
        width: 64px;
        height: 64px;
        transition: 0.2s;
      }

      .app-icon:hover img {
        transform: scale(1.1);
      }

      .app-icon p {
        color: #333;
        font-size: 13px;
        margin-top: 4px;
      }

      /* ناحیه کلی دسکتاپ */
      #desktop-area {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(180deg, #e8eaed, #cfd2d6);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      /* بخش آیکون‌ها در وسط صفحه */
      #desktop-icons {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start; /* شروع از سمت چپ */
        align-items: center;
        gap: 25px;
        width: 70%;
        max-width: 800px;
        padding: 20px;
      }

      /* آیکون هر اپلیکیشن */
      .app-icon {
        width: 90px;
        height: 90px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        backdrop-filter: blur(6px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        text-align: center;
        user-select: none;
      }

      .app-icon img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 8px;
      }

      .app-icon p {
        font-size: 14px;
        color: #2e2e2e;
        margin: 0;
        font-weight: 500;
      }

      /* اضافه کنید یا جایگزین قبلی کنید */
      .app-window {
        transition: transform 300ms ease, opacity 250ms ease;
        transform-origin: center bottom;
        /* مطمئن شید در حالت عادی قابل کلیک باشه */
        pointer-events: auto;
      }

      /* کلاس وقتی در حال مینیمایز شدن هست (انیمیشن) */
      .app-window.minimized {
        transform: scale(0.12) translateY(220px);
        opacity: 0;
        pointer-events: none;
      }

      /* کلاس وقتی پس از مینیمایز کامل می‌خواهیم کاملاً مخفی باشه */
      .app-window.hidden {
        display: none !important;
      }

      .app-header {
        background: linear-gradient(180deg, #585858, #404040);
        color: white;
        padding: 6px 10px;
        cursor: move;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 8px 8px 0 0;
      }

      .window-controls button {
        background: none;
        border: none;
        color: white;
        font-weight: bold;
        margin-left: 8px;
        cursor: pointer;
        transition: 0.2s;
      }
      .window-controls button:hover {
        color: #ff6961;
      }

      .app-body {
        background: white;
        height: calc(100% - 35px);
        overflow: auto;
        padding: 10px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .taskbar {
        position: fixed;
        bottom: 99px; /* کمی بالاتر از مهارت‌ها */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(40, 40, 40, 0.8);
        color: white;
        border-top-left-radius: 25px;
        border-top-right-radius: 25px;
        padding: 6px 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 200px;
        max-width: 60%;
        justify-content: center;
        backdrop-filter: blur(6px);
        z-index: 1000;
      }

      .taskbar-item {
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 4px 10px;
        cursor: pointer;
        transition: 0.2s;
      }

      .taskbar-item:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .taskbar-item img {
        width: 20px;
        height: 20px;
      }

      .window-buttons {
        display: flex;
        gap: 6px;
      }

      .window-buttons button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 4px;
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }

      .window-buttons button:hover {
        background: rgba(255, 255, 255, 0.4);
      }

      /* 🔹 انیمیشن باز شدن */
      @keyframes appOpen {
        0% {
          opacity: 0;
          transform: scale(0.85) translateY(20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      /* 🔹 انیمیشن بسته شدن */
      @keyframes appClose {
        0% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
        100% {
          opacity: 0;
          transform: scale(0.85) translateY(20px);
        }
      }

      /* 🔹 حالت‌های انیمیشنی */
      .app-window {
        animation: appOpen 0.3s ease forwards;
        transition: opacity 0.3s, transform 0.3s;
      }

      .app-window.closing {
        animation: appClose 0.3s ease forwards;
      }
    </style>
  </head>
  <body>
    <!-- top part -->
    <div class="fixed-top-right">
      <div id="date-display"></div>
      <div id="time-display"></div>
      <div id="battery-container">
        <div id="battery-outline">
          <div id="battery-level"></div>
        </div>
        <div id="battery-cap"></div>
        <span id="battery-percentage"></span>
      </div>
    </div>

    <!-- Main part -->
    <div id="desktop-area">
      <div id="desktop-icons">
        {% for app in webApps %}
        <div
          class="app-icon"
          data-app="{{ app.name|slugify }}"
          data-name="{{ app.name }}"
          data-html="{{ app.html_content|escapejs }}"
          data-css="{{ app.css_content|escapejs }}"
          data-js="{{ app.js_content|escapejs }}"
          onclick="openApp(this)"
        >
          <img src="{{ app.get_icon_url }}" alt="{{ app.name }}" />
          <p>{{ app.name }}</p>
        </div>
        {% endfor %}
      </div>

      <div id="window-container"></div>
    </div>
    <!-- bottom part -->
    <div class="row fixed-bottom justify-content-center">
      <div id="taskbar" class="taskbar"></div>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        style="display: block; position: absolute"
        width="0"
        height="0"
      >
        <defs>
          <clipPath id="clip" clipPathUnits="objectBoundingBox">
            <path
              d="M0.065,0H0.935A0.065,0.26,0,0,1,1,0.26V0.74A0.065,0.26,0,0,1,0.935,1H0.065A0.065,0.26,0,0,1,0,0.74V0.26A0.065,0.26,0,0,1,0.065,0Z"
            />
          </clipPath>
        </defs>
      </svg>
      <div
        class="inverted d-flex flex-wrap justify-content-center align-items-center"
        style="border-radius: 60px"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          style="display: block; position: absolute"
          width="0"
          height="0"
        >
          <defs>
            <clipPath id="clip" clipPathUnits="objectBoundingBox">
              <path
                d="M0.195,0H0.805A0.195,0.195,0,0,1,1,0.195V0.805A0.195,0.195,0,0,1,0.805,1H0.195A0.195,0.195,0,0,1,0,0.805V0.195A0.195,0.195,0,0,1,0.195,0Z"
              />
            </clipPath>
          </defs>
        </svg>
        {% for skills in Skill %}
        <div
          class="skill-box"
          style="--color: {{ skills.color }}; clip-path: url(#clip);width: 80px;height: 75px;aspect-ratio: 1 / 1;border-radius: 20px;"
          data-bs-toggle="tooltip"
          title="{{ skills.title }}"
        >
          <img src="{{ skills.get_icon_url }}" alt="{{ skills.title }}" />
        </div>
        {% empty %}
        <p>there is no skills</p>
        {% endfor %}
      </div>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"
  ></script>
  <script>
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
      const date = now.toLocaleDateString(undefined, {
        weekday: "short",
        month: "short",
        day: "numeric",
      });
      document.getElementById("time-display").textContent = time;
      document.getElementById("date-display").textContent = date;
    }

    setInterval(updateClock, 1000);
    updateClock();

    if ("getBattery" in navigator) {
      navigator.getBattery().then(function (battery) {
        function updateBattery() {
          const level = Math.round(battery.level * 100);
          document.getElementById(
            "battery-display"
          ).textContent = `🔋${level}%`;
        }
        updateBattery();
        battery.addEventListener("levelchange", updateBattery);
      });
    } else {
      document.getElementById("battery-display").textContent = "🔋N/A";
    }

    async function updateBattery() {
      if ("getBattery" in navigator) {
        const battery = await navigator.getBattery();
        const levelBar = document.getElementById("battery-level");
        const percentageText = document.getElementById("battery-percentage");

        function updateAll() {
          const level = Math.round(battery.level * 100);
          percentageText.textContent = level + "%";
          levelBar.style.width = level + "%";

          if (battery.charging) {
            levelBar.style.background = "#00bcd4"; // آبی در حالت شارژ
          } else if (level > 80) {
            levelBar.style.background = "#4caf50"; // سبز
          } else if (level > 40) {
            levelBar.style.background = "#ffeb3b"; // زرد
          } else if (level > 15) {
            levelBar.style.background = "#ff9800"; // نارنجی
          } else {
            levelBar.style.background = "#f44336"; // قرمز
          }
        }

        updateAll();
        battery.addEventListener("levelchange", updateAll);
        battery.addEventListener("chargingchange", updateAll);
      } else {
        document.getElementById("battery-container").innerHTML =
          "Battery info not supported";
      }
    }

    updateBattery();

    let highestZ = 10;

    function setupWindow(win) {
      const header = win.querySelector(".app-header");
      const minimize = win.querySelector(".minimize-btn");
      const maximize = win.querySelector(".maximize-btn");
      const close = win.querySelector(".close-btn");
      const body = win.querySelector(".app-body");

      // bring to front
      win.addEventListener("mousedown", () => {
        win.style.zIndex = ++highestZ;
      });

      // dragging
      let offsetX = 0,
        offsetY = 0,
        dragging = false;

      header.addEventListener("mousedown", (e) => {
        dragging = true;
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        win.style.zIndex = ++highestZ;
      });

      document.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        win.style.left = `${e.clientX - offsetX}px`;
        win.style.top = `${e.clientY - offsetY}px`;
      });

      document.addEventListener("mouseup", () => (dragging = false));

      // close button
      close.addEventListener("click", () => win.remove());

      // minimize
      minimize.addEventListener("click", () => {
        body.style.display = body.style.display === "none" ? "block" : "none";
      });

      // maximize
      maximize.addEventListener("click", () => {
        if (win.classList.contains("maximized")) {
          win.style.top = win.dataset.prevTop;
          win.style.left = win.dataset.prevLeft;
          win.style.width = win.dataset.prevWidth;
          win.style.height = win.dataset.prevHeight;
          win.classList.remove("maximized");
        } else {
          win.dataset.prevTop = win.style.top;
          win.dataset.prevLeft = win.style.left;
          win.dataset.prevWidth = win.style.width;
          win.dataset.prevHeight = win.style.height;
          win.style.top = "0";
          win.style.left = "0";
          win.style.width = "100vw";
          win.style.height = "100vh";
          win.classList.add("maximized");
        }
      });
    }

    // یک متغیر برای افزایش z-index برای اینکه پنجره بازشده جلو باشه
    let topZ = 1000;

    function bringToFront(el) {
      topZ += 1;
      el.style.zIndex = topZ;
    }

    window.openApp = function (el) {
      const slug = el.dataset.app;
      const name = el.dataset.name;
      const htmlContent = JSON.parse('"' + el.dataset.html + '"');
      const cssContent = JSON.parse('"' + el.dataset.css + '"');
      const jsContent = JSON.parse('"' + el.dataset.js + '"');

      let existing = document.getElementById(`window-${slug}`);
      if (existing) {
        existing.style.display = "block";
        existing.classList.remove("minimized");
        return;
      }

      // ساخت پنجره برنامه
      const windowDiv = document.createElement("div");
      windowDiv.className = "app-window";
      windowDiv.id = `window-${slug}`;
      windowDiv.innerHTML = `
    <div class="app-header">
      <span>${name}</span>
      <div class="window-buttons">
        <button onclick="minimizeApp('${slug}')">—</button>
        <button onclick="closeApp('${slug}')">×</button>
      </div>
    </div>
    <div class="app-body">${htmlContent}</div>
  `;
      document.getElementById("window-container").appendChild(windowDiv);

      windowDiv.style.animation = "appOpen 0.3s ease";

      // ساخت آیکون در تسک‌بار
      const taskbar = document.getElementById("taskbar");
      if (!document.getElementById(`task-${slug}`)) {
        const taskIcon = document.createElement("div");
        taskIcon.className = "task-icon";
        taskIcon.id = `task-${slug}`;
        taskIcon.innerHTML = `<img src="${
          el.querySelector("img").src
        }" alt="${name}" style="width:28px;height:28px;">`;
        taskIcon.onclick = () => toggleApp(slug);
        taskbar.appendChild(taskIcon);
      }

      // اضافه کردن CSS و JS اختصاصی
      if (cssContent.trim()) {
        const styleTag = document.createElement("style");
        styleTag.textContent = cssContent;
        windowDiv.appendChild(styleTag);
      }

      if (jsContent.trim()) {
        const scriptTag = document.createElement("script");
        scriptTag.textContent = jsContent;
        windowDiv.appendChild(scriptTag);
      }

      makeDraggable(windowDiv);
      setupWindow(windowDiv);
      bringToFront(windowDiv);
    };

    function makeDraggable(el) {
      const header = el.querySelector(".app-header");
      if (!header) return;

      let offsetX = 0,
        offsetY = 0,
        isDragging = false;

      header.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        el.style.left = e.clientX - offsetX + "px";
        el.style.top = e.clientY - offsetY + "px";
      });

      document.addEventListener("mouseup", () => (isDragging = false));
    }

    window.minimizeApp = function (slug) {
      const app = document.getElementById(`window-${slug}`);
      if (app) {
        app.classList.add("closing");
        setTimeout(() => {
          app.style.display = "none";
          app.classList.remove("closing");
        }, 300); // زمان هماهنگ با انیمیشن
      }
    };

    window.closeApp = function (slug) {
      const app = document.getElementById(`window-${slug}`);
      const task = document.getElementById(`task-${slug}`);
      if (app) {
        app.classList.add("closing");
        setTimeout(() => {
          app.remove();
          if (task) task.remove();
        }, 300);
      }
    };

    window.toggleApp = function (slug) {
      const app = document.getElementById(`window-${slug}`);
      if (!app) return;
      if (app.style.display === "none") app.style.display = "block";
      else app.style.display = "none";
    };
  </script>
</html>
